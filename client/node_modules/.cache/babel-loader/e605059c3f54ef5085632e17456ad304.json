{"ast":null,"code":"\"use strict\";\n\nlet interlaceUtils = require(\"./interlace\");\n\nlet pixelBppMapper = [// 0 - dummy entry\nfunction () {}, // 1 - L\n// 0: 0, 1: 0, 2: 0, 3: 0xff\nfunction (pxData, data, pxPos, rawPos) {\n  if (rawPos === data.length) {\n    throw new Error(\"Ran out of data\");\n  }\n\n  let pixel = data[rawPos];\n  pxData[pxPos] = pixel;\n  pxData[pxPos + 1] = pixel;\n  pxData[pxPos + 2] = pixel;\n  pxData[pxPos + 3] = 0xff;\n}, // 2 - LA\n// 0: 0, 1: 0, 2: 0, 3: 1\nfunction (pxData, data, pxPos, rawPos) {\n  if (rawPos + 1 >= data.length) {\n    throw new Error(\"Ran out of data\");\n  }\n\n  let pixel = data[rawPos];\n  pxData[pxPos] = pixel;\n  pxData[pxPos + 1] = pixel;\n  pxData[pxPos + 2] = pixel;\n  pxData[pxPos + 3] = data[rawPos + 1];\n}, // 3 - RGB\n// 0: 0, 1: 1, 2: 2, 3: 0xff\nfunction (pxData, data, pxPos, rawPos) {\n  if (rawPos + 2 >= data.length) {\n    throw new Error(\"Ran out of data\");\n  }\n\n  pxData[pxPos] = data[rawPos];\n  pxData[pxPos + 1] = data[rawPos + 1];\n  pxData[pxPos + 2] = data[rawPos + 2];\n  pxData[pxPos + 3] = 0xff;\n}, // 4 - RGBA\n// 0: 0, 1: 1, 2: 2, 3: 3\nfunction (pxData, data, pxPos, rawPos) {\n  if (rawPos + 3 >= data.length) {\n    throw new Error(\"Ran out of data\");\n  }\n\n  pxData[pxPos] = data[rawPos];\n  pxData[pxPos + 1] = data[rawPos + 1];\n  pxData[pxPos + 2] = data[rawPos + 2];\n  pxData[pxPos + 3] = data[rawPos + 3];\n}];\nlet pixelBppCustomMapper = [// 0 - dummy entry\nfunction () {}, // 1 - L\n// 0: 0, 1: 0, 2: 0, 3: 0xff\nfunction (pxData, pixelData, pxPos, maxBit) {\n  let pixel = pixelData[0];\n  pxData[pxPos] = pixel;\n  pxData[pxPos + 1] = pixel;\n  pxData[pxPos + 2] = pixel;\n  pxData[pxPos + 3] = maxBit;\n}, // 2 - LA\n// 0: 0, 1: 0, 2: 0, 3: 1\nfunction (pxData, pixelData, pxPos) {\n  let pixel = pixelData[0];\n  pxData[pxPos] = pixel;\n  pxData[pxPos + 1] = pixel;\n  pxData[pxPos + 2] = pixel;\n  pxData[pxPos + 3] = pixelData[1];\n}, // 3 - RGB\n// 0: 0, 1: 1, 2: 2, 3: 0xff\nfunction (pxData, pixelData, pxPos, maxBit) {\n  pxData[pxPos] = pixelData[0];\n  pxData[pxPos + 1] = pixelData[1];\n  pxData[pxPos + 2] = pixelData[2];\n  pxData[pxPos + 3] = maxBit;\n}, // 4 - RGBA\n// 0: 0, 1: 1, 2: 2, 3: 3\nfunction (pxData, pixelData, pxPos) {\n  pxData[pxPos] = pixelData[0];\n  pxData[pxPos + 1] = pixelData[1];\n  pxData[pxPos + 2] = pixelData[2];\n  pxData[pxPos + 3] = pixelData[3];\n}];\n\nfunction bitRetriever(data, depth) {\n  let leftOver = [];\n  let i = 0;\n\n  function split() {\n    if (i === data.length) {\n      throw new Error(\"Ran out of data\");\n    }\n\n    let byte = data[i];\n    i++;\n    let byte8, byte7, byte6, byte5, byte4, byte3, byte2, byte1;\n\n    switch (depth) {\n      default:\n        throw new Error(\"unrecognised depth\");\n\n      case 16:\n        byte2 = data[i];\n        i++;\n        leftOver.push((byte << 8) + byte2);\n        break;\n\n      case 4:\n        byte2 = byte & 0x0f;\n        byte1 = byte >> 4;\n        leftOver.push(byte1, byte2);\n        break;\n\n      case 2:\n        byte4 = byte & 3;\n        byte3 = byte >> 2 & 3;\n        byte2 = byte >> 4 & 3;\n        byte1 = byte >> 6 & 3;\n        leftOver.push(byte1, byte2, byte3, byte4);\n        break;\n\n      case 1:\n        byte8 = byte & 1;\n        byte7 = byte >> 1 & 1;\n        byte6 = byte >> 2 & 1;\n        byte5 = byte >> 3 & 1;\n        byte4 = byte >> 4 & 1;\n        byte3 = byte >> 5 & 1;\n        byte2 = byte >> 6 & 1;\n        byte1 = byte >> 7 & 1;\n        leftOver.push(byte1, byte2, byte3, byte4, byte5, byte6, byte7, byte8);\n        break;\n    }\n  }\n\n  return {\n    get: function (count) {\n      while (leftOver.length < count) {\n        split();\n      }\n\n      let returner = leftOver.slice(0, count);\n      leftOver = leftOver.slice(count);\n      return returner;\n    },\n    resetAfterLine: function () {\n      leftOver.length = 0;\n    },\n    end: function () {\n      if (i !== data.length) {\n        throw new Error(\"extra data found\");\n      }\n    }\n  };\n}\n\nfunction mapImage8Bit(image, pxData, getPxPos, bpp, data, rawPos) {\n  // eslint-disable-line max-params\n  let imageWidth = image.width;\n  let imageHeight = image.height;\n  let imagePass = image.index;\n\n  for (let y = 0; y < imageHeight; y++) {\n    for (let x = 0; x < imageWidth; x++) {\n      let pxPos = getPxPos(x, y, imagePass);\n      pixelBppMapper[bpp](pxData, data, pxPos, rawPos);\n      rawPos += bpp; //eslint-disable-line no-param-reassign\n    }\n  }\n\n  return rawPos;\n}\n\nfunction mapImageCustomBit(image, pxData, getPxPos, bpp, bits, maxBit) {\n  // eslint-disable-line max-params\n  let imageWidth = image.width;\n  let imageHeight = image.height;\n  let imagePass = image.index;\n\n  for (let y = 0; y < imageHeight; y++) {\n    for (let x = 0; x < imageWidth; x++) {\n      let pixelData = bits.get(bpp);\n      let pxPos = getPxPos(x, y, imagePass);\n      pixelBppCustomMapper[bpp](pxData, pixelData, pxPos, maxBit);\n    }\n\n    bits.resetAfterLine();\n  }\n}\n\nexports.dataToBitMap = function (data, bitmapInfo) {\n  let width = bitmapInfo.width;\n  let height = bitmapInfo.height;\n  let depth = bitmapInfo.depth;\n  let bpp = bitmapInfo.bpp;\n  let interlace = bitmapInfo.interlace;\n  let bits;\n\n  if (depth !== 8) {\n    bits = bitRetriever(data, depth);\n  }\n\n  let pxData;\n\n  if (depth <= 8) {\n    pxData = Buffer.alloc(width * height * 4);\n  } else {\n    pxData = new Uint16Array(width * height * 4);\n  }\n\n  let maxBit = Math.pow(2, depth) - 1;\n  let rawPos = 0;\n  let images;\n  let getPxPos;\n\n  if (interlace) {\n    images = interlaceUtils.getImagePasses(width, height);\n    getPxPos = interlaceUtils.getInterlaceIterator(width, height);\n  } else {\n    let nonInterlacedPxPos = 0;\n\n    getPxPos = function () {\n      let returner = nonInterlacedPxPos;\n      nonInterlacedPxPos += 4;\n      return returner;\n    };\n\n    images = [{\n      width: width,\n      height: height\n    }];\n  }\n\n  for (let imageIndex = 0; imageIndex < images.length; imageIndex++) {\n    if (depth === 8) {\n      rawPos = mapImage8Bit(images[imageIndex], pxData, getPxPos, bpp, data, rawPos);\n    } else {\n      mapImageCustomBit(images[imageIndex], pxData, getPxPos, bpp, bits, maxBit);\n    }\n  }\n\n  if (depth === 8) {\n    if (rawPos !== data.length) {\n      throw new Error(\"extra data found\");\n    }\n  } else {\n    bits.end();\n  }\n\n  return pxData;\n};","map":{"version":3,"sources":["/Users/marcusnorwood/Sites/music-site/dale-street-studio-music/client/node_modules/pngjs/lib/bitmapper.js"],"names":["interlaceUtils","require","pixelBppMapper","pxData","data","pxPos","rawPos","length","Error","pixel","pixelBppCustomMapper","pixelData","maxBit","bitRetriever","depth","leftOver","i","split","byte","byte8","byte7","byte6","byte5","byte4","byte3","byte2","byte1","push","get","count","returner","slice","resetAfterLine","end","mapImage8Bit","image","getPxPos","bpp","imageWidth","width","imageHeight","height","imagePass","index","y","x","mapImageCustomBit","bits","exports","dataToBitMap","bitmapInfo","interlace","Buffer","alloc","Uint16Array","Math","pow","images","getImagePasses","getInterlaceIterator","nonInterlacedPxPos","imageIndex"],"mappings":"AAAA;;AAEA,IAAIA,cAAc,GAAGC,OAAO,CAAC,aAAD,CAA5B;;AAEA,IAAIC,cAAc,GAAG,CACnB;AACA,YAAY,CAAE,CAFK,EAInB;AACA;AACA,UAAUC,MAAV,EAAkBC,IAAlB,EAAwBC,KAAxB,EAA+BC,MAA/B,EAAuC;AACrC,MAAIA,MAAM,KAAKF,IAAI,CAACG,MAApB,EAA4B;AAC1B,UAAM,IAAIC,KAAJ,CAAU,iBAAV,CAAN;AACD;;AAED,MAAIC,KAAK,GAAGL,IAAI,CAACE,MAAD,CAAhB;AACAH,EAAAA,MAAM,CAACE,KAAD,CAAN,GAAgBI,KAAhB;AACAN,EAAAA,MAAM,CAACE,KAAK,GAAG,CAAT,CAAN,GAAoBI,KAApB;AACAN,EAAAA,MAAM,CAACE,KAAK,GAAG,CAAT,CAAN,GAAoBI,KAApB;AACAN,EAAAA,MAAM,CAACE,KAAK,GAAG,CAAT,CAAN,GAAoB,IAApB;AACD,CAhBkB,EAkBnB;AACA;AACA,UAAUF,MAAV,EAAkBC,IAAlB,EAAwBC,KAAxB,EAA+BC,MAA/B,EAAuC;AACrC,MAAIA,MAAM,GAAG,CAAT,IAAcF,IAAI,CAACG,MAAvB,EAA+B;AAC7B,UAAM,IAAIC,KAAJ,CAAU,iBAAV,CAAN;AACD;;AAED,MAAIC,KAAK,GAAGL,IAAI,CAACE,MAAD,CAAhB;AACAH,EAAAA,MAAM,CAACE,KAAD,CAAN,GAAgBI,KAAhB;AACAN,EAAAA,MAAM,CAACE,KAAK,GAAG,CAAT,CAAN,GAAoBI,KAApB;AACAN,EAAAA,MAAM,CAACE,KAAK,GAAG,CAAT,CAAN,GAAoBI,KAApB;AACAN,EAAAA,MAAM,CAACE,KAAK,GAAG,CAAT,CAAN,GAAoBD,IAAI,CAACE,MAAM,GAAG,CAAV,CAAxB;AACD,CA9BkB,EAgCnB;AACA;AACA,UAAUH,MAAV,EAAkBC,IAAlB,EAAwBC,KAAxB,EAA+BC,MAA/B,EAAuC;AACrC,MAAIA,MAAM,GAAG,CAAT,IAAcF,IAAI,CAACG,MAAvB,EAA+B;AAC7B,UAAM,IAAIC,KAAJ,CAAU,iBAAV,CAAN;AACD;;AAEDL,EAAAA,MAAM,CAACE,KAAD,CAAN,GAAgBD,IAAI,CAACE,MAAD,CAApB;AACAH,EAAAA,MAAM,CAACE,KAAK,GAAG,CAAT,CAAN,GAAoBD,IAAI,CAACE,MAAM,GAAG,CAAV,CAAxB;AACAH,EAAAA,MAAM,CAACE,KAAK,GAAG,CAAT,CAAN,GAAoBD,IAAI,CAACE,MAAM,GAAG,CAAV,CAAxB;AACAH,EAAAA,MAAM,CAACE,KAAK,GAAG,CAAT,CAAN,GAAoB,IAApB;AACD,CA3CkB,EA6CnB;AACA;AACA,UAAUF,MAAV,EAAkBC,IAAlB,EAAwBC,KAAxB,EAA+BC,MAA/B,EAAuC;AACrC,MAAIA,MAAM,GAAG,CAAT,IAAcF,IAAI,CAACG,MAAvB,EAA+B;AAC7B,UAAM,IAAIC,KAAJ,CAAU,iBAAV,CAAN;AACD;;AAEDL,EAAAA,MAAM,CAACE,KAAD,CAAN,GAAgBD,IAAI,CAACE,MAAD,CAApB;AACAH,EAAAA,MAAM,CAACE,KAAK,GAAG,CAAT,CAAN,GAAoBD,IAAI,CAACE,MAAM,GAAG,CAAV,CAAxB;AACAH,EAAAA,MAAM,CAACE,KAAK,GAAG,CAAT,CAAN,GAAoBD,IAAI,CAACE,MAAM,GAAG,CAAV,CAAxB;AACAH,EAAAA,MAAM,CAACE,KAAK,GAAG,CAAT,CAAN,GAAoBD,IAAI,CAACE,MAAM,GAAG,CAAV,CAAxB;AACD,CAxDkB,CAArB;AA2DA,IAAII,oBAAoB,GAAG,CACzB;AACA,YAAY,CAAE,CAFW,EAIzB;AACA;AACA,UAAUP,MAAV,EAAkBQ,SAAlB,EAA6BN,KAA7B,EAAoCO,MAApC,EAA4C;AAC1C,MAAIH,KAAK,GAAGE,SAAS,CAAC,CAAD,CAArB;AACAR,EAAAA,MAAM,CAACE,KAAD,CAAN,GAAgBI,KAAhB;AACAN,EAAAA,MAAM,CAACE,KAAK,GAAG,CAAT,CAAN,GAAoBI,KAApB;AACAN,EAAAA,MAAM,CAACE,KAAK,GAAG,CAAT,CAAN,GAAoBI,KAApB;AACAN,EAAAA,MAAM,CAACE,KAAK,GAAG,CAAT,CAAN,GAAoBO,MAApB;AACD,CAZwB,EAczB;AACA;AACA,UAAUT,MAAV,EAAkBQ,SAAlB,EAA6BN,KAA7B,EAAoC;AAClC,MAAII,KAAK,GAAGE,SAAS,CAAC,CAAD,CAArB;AACAR,EAAAA,MAAM,CAACE,KAAD,CAAN,GAAgBI,KAAhB;AACAN,EAAAA,MAAM,CAACE,KAAK,GAAG,CAAT,CAAN,GAAoBI,KAApB;AACAN,EAAAA,MAAM,CAACE,KAAK,GAAG,CAAT,CAAN,GAAoBI,KAApB;AACAN,EAAAA,MAAM,CAACE,KAAK,GAAG,CAAT,CAAN,GAAoBM,SAAS,CAAC,CAAD,CAA7B;AACD,CAtBwB,EAwBzB;AACA;AACA,UAAUR,MAAV,EAAkBQ,SAAlB,EAA6BN,KAA7B,EAAoCO,MAApC,EAA4C;AAC1CT,EAAAA,MAAM,CAACE,KAAD,CAAN,GAAgBM,SAAS,CAAC,CAAD,CAAzB;AACAR,EAAAA,MAAM,CAACE,KAAK,GAAG,CAAT,CAAN,GAAoBM,SAAS,CAAC,CAAD,CAA7B;AACAR,EAAAA,MAAM,CAACE,KAAK,GAAG,CAAT,CAAN,GAAoBM,SAAS,CAAC,CAAD,CAA7B;AACAR,EAAAA,MAAM,CAACE,KAAK,GAAG,CAAT,CAAN,GAAoBO,MAApB;AACD,CA/BwB,EAiCzB;AACA;AACA,UAAUT,MAAV,EAAkBQ,SAAlB,EAA6BN,KAA7B,EAAoC;AAClCF,EAAAA,MAAM,CAACE,KAAD,CAAN,GAAgBM,SAAS,CAAC,CAAD,CAAzB;AACAR,EAAAA,MAAM,CAACE,KAAK,GAAG,CAAT,CAAN,GAAoBM,SAAS,CAAC,CAAD,CAA7B;AACAR,EAAAA,MAAM,CAACE,KAAK,GAAG,CAAT,CAAN,GAAoBM,SAAS,CAAC,CAAD,CAA7B;AACAR,EAAAA,MAAM,CAACE,KAAK,GAAG,CAAT,CAAN,GAAoBM,SAAS,CAAC,CAAD,CAA7B;AACD,CAxCwB,CAA3B;;AA2CA,SAASE,YAAT,CAAsBT,IAAtB,EAA4BU,KAA5B,EAAmC;AACjC,MAAIC,QAAQ,GAAG,EAAf;AACA,MAAIC,CAAC,GAAG,CAAR;;AAEA,WAASC,KAAT,GAAiB;AACf,QAAID,CAAC,KAAKZ,IAAI,CAACG,MAAf,EAAuB;AACrB,YAAM,IAAIC,KAAJ,CAAU,iBAAV,CAAN;AACD;;AACD,QAAIU,IAAI,GAAGd,IAAI,CAACY,CAAD,CAAf;AACAA,IAAAA,CAAC;AACD,QAAIG,KAAJ,EAAWC,KAAX,EAAkBC,KAAlB,EAAyBC,KAAzB,EAAgCC,KAAhC,EAAuCC,KAAvC,EAA8CC,KAA9C,EAAqDC,KAArD;;AACA,YAAQZ,KAAR;AACE;AACE,cAAM,IAAIN,KAAJ,CAAU,oBAAV,CAAN;;AACF,WAAK,EAAL;AACEiB,QAAAA,KAAK,GAAGrB,IAAI,CAACY,CAAD,CAAZ;AACAA,QAAAA,CAAC;AACDD,QAAAA,QAAQ,CAACY,IAAT,CAAc,CAACT,IAAI,IAAI,CAAT,IAAcO,KAA5B;AACA;;AACF,WAAK,CAAL;AACEA,QAAAA,KAAK,GAAGP,IAAI,GAAG,IAAf;AACAQ,QAAAA,KAAK,GAAGR,IAAI,IAAI,CAAhB;AACAH,QAAAA,QAAQ,CAACY,IAAT,CAAcD,KAAd,EAAqBD,KAArB;AACA;;AACF,WAAK,CAAL;AACEF,QAAAA,KAAK,GAAGL,IAAI,GAAG,CAAf;AACAM,QAAAA,KAAK,GAAIN,IAAI,IAAI,CAAT,GAAc,CAAtB;AACAO,QAAAA,KAAK,GAAIP,IAAI,IAAI,CAAT,GAAc,CAAtB;AACAQ,QAAAA,KAAK,GAAIR,IAAI,IAAI,CAAT,GAAc,CAAtB;AACAH,QAAAA,QAAQ,CAACY,IAAT,CAAcD,KAAd,EAAqBD,KAArB,EAA4BD,KAA5B,EAAmCD,KAAnC;AACA;;AACF,WAAK,CAAL;AACEJ,QAAAA,KAAK,GAAGD,IAAI,GAAG,CAAf;AACAE,QAAAA,KAAK,GAAIF,IAAI,IAAI,CAAT,GAAc,CAAtB;AACAG,QAAAA,KAAK,GAAIH,IAAI,IAAI,CAAT,GAAc,CAAtB;AACAI,QAAAA,KAAK,GAAIJ,IAAI,IAAI,CAAT,GAAc,CAAtB;AACAK,QAAAA,KAAK,GAAIL,IAAI,IAAI,CAAT,GAAc,CAAtB;AACAM,QAAAA,KAAK,GAAIN,IAAI,IAAI,CAAT,GAAc,CAAtB;AACAO,QAAAA,KAAK,GAAIP,IAAI,IAAI,CAAT,GAAc,CAAtB;AACAQ,QAAAA,KAAK,GAAIR,IAAI,IAAI,CAAT,GAAc,CAAtB;AACAH,QAAAA,QAAQ,CAACY,IAAT,CAAcD,KAAd,EAAqBD,KAArB,EAA4BD,KAA5B,EAAmCD,KAAnC,EAA0CD,KAA1C,EAAiDD,KAAjD,EAAwDD,KAAxD,EAA+DD,KAA/D;AACA;AA9BJ;AAgCD;;AAED,SAAO;AACLS,IAAAA,GAAG,EAAE,UAAUC,KAAV,EAAiB;AACpB,aAAOd,QAAQ,CAACR,MAAT,GAAkBsB,KAAzB,EAAgC;AAC9BZ,QAAAA,KAAK;AACN;;AACD,UAAIa,QAAQ,GAAGf,QAAQ,CAACgB,KAAT,CAAe,CAAf,EAAkBF,KAAlB,CAAf;AACAd,MAAAA,QAAQ,GAAGA,QAAQ,CAACgB,KAAT,CAAeF,KAAf,CAAX;AACA,aAAOC,QAAP;AACD,KARI;AASLE,IAAAA,cAAc,EAAE,YAAY;AAC1BjB,MAAAA,QAAQ,CAACR,MAAT,GAAkB,CAAlB;AACD,KAXI;AAYL0B,IAAAA,GAAG,EAAE,YAAY;AACf,UAAIjB,CAAC,KAAKZ,IAAI,CAACG,MAAf,EAAuB;AACrB,cAAM,IAAIC,KAAJ,CAAU,kBAAV,CAAN;AACD;AACF;AAhBI,GAAP;AAkBD;;AAED,SAAS0B,YAAT,CAAsBC,KAAtB,EAA6BhC,MAA7B,EAAqCiC,QAArC,EAA+CC,GAA/C,EAAoDjC,IAApD,EAA0DE,MAA1D,EAAkE;AAChE;AACA,MAAIgC,UAAU,GAAGH,KAAK,CAACI,KAAvB;AACA,MAAIC,WAAW,GAAGL,KAAK,CAACM,MAAxB;AACA,MAAIC,SAAS,GAAGP,KAAK,CAACQ,KAAtB;;AACA,OAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGJ,WAApB,EAAiCI,CAAC,EAAlC,EAAsC;AACpC,SAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGP,UAApB,EAAgCO,CAAC,EAAjC,EAAqC;AACnC,UAAIxC,KAAK,GAAG+B,QAAQ,CAACS,CAAD,EAAID,CAAJ,EAAOF,SAAP,CAApB;AACAxC,MAAAA,cAAc,CAACmC,GAAD,CAAd,CAAoBlC,MAApB,EAA4BC,IAA5B,EAAkCC,KAAlC,EAAyCC,MAAzC;AACAA,MAAAA,MAAM,IAAI+B,GAAV,CAHmC,CAGpB;AAChB;AACF;;AACD,SAAO/B,MAAP;AACD;;AAED,SAASwC,iBAAT,CAA2BX,KAA3B,EAAkChC,MAAlC,EAA0CiC,QAA1C,EAAoDC,GAApD,EAAyDU,IAAzD,EAA+DnC,MAA/D,EAAuE;AACrE;AACA,MAAI0B,UAAU,GAAGH,KAAK,CAACI,KAAvB;AACA,MAAIC,WAAW,GAAGL,KAAK,CAACM,MAAxB;AACA,MAAIC,SAAS,GAAGP,KAAK,CAACQ,KAAtB;;AACA,OAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGJ,WAApB,EAAiCI,CAAC,EAAlC,EAAsC;AACpC,SAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGP,UAApB,EAAgCO,CAAC,EAAjC,EAAqC;AACnC,UAAIlC,SAAS,GAAGoC,IAAI,CAACnB,GAAL,CAASS,GAAT,CAAhB;AACA,UAAIhC,KAAK,GAAG+B,QAAQ,CAACS,CAAD,EAAID,CAAJ,EAAOF,SAAP,CAApB;AACAhC,MAAAA,oBAAoB,CAAC2B,GAAD,CAApB,CAA0BlC,MAA1B,EAAkCQ,SAAlC,EAA6CN,KAA7C,EAAoDO,MAApD;AACD;;AACDmC,IAAAA,IAAI,CAACf,cAAL;AACD;AACF;;AAEDgB,OAAO,CAACC,YAAR,GAAuB,UAAU7C,IAAV,EAAgB8C,UAAhB,EAA4B;AACjD,MAAIX,KAAK,GAAGW,UAAU,CAACX,KAAvB;AACA,MAAIE,MAAM,GAAGS,UAAU,CAACT,MAAxB;AACA,MAAI3B,KAAK,GAAGoC,UAAU,CAACpC,KAAvB;AACA,MAAIuB,GAAG,GAAGa,UAAU,CAACb,GAArB;AACA,MAAIc,SAAS,GAAGD,UAAU,CAACC,SAA3B;AACA,MAAIJ,IAAJ;;AAEA,MAAIjC,KAAK,KAAK,CAAd,EAAiB;AACfiC,IAAAA,IAAI,GAAGlC,YAAY,CAACT,IAAD,EAAOU,KAAP,CAAnB;AACD;;AACD,MAAIX,MAAJ;;AACA,MAAIW,KAAK,IAAI,CAAb,EAAgB;AACdX,IAAAA,MAAM,GAAGiD,MAAM,CAACC,KAAP,CAAad,KAAK,GAAGE,MAAR,GAAiB,CAA9B,CAAT;AACD,GAFD,MAEO;AACLtC,IAAAA,MAAM,GAAG,IAAImD,WAAJ,CAAgBf,KAAK,GAAGE,MAAR,GAAiB,CAAjC,CAAT;AACD;;AACD,MAAI7B,MAAM,GAAG2C,IAAI,CAACC,GAAL,CAAS,CAAT,EAAY1C,KAAZ,IAAqB,CAAlC;AACA,MAAIR,MAAM,GAAG,CAAb;AACA,MAAImD,MAAJ;AACA,MAAIrB,QAAJ;;AAEA,MAAIe,SAAJ,EAAe;AACbM,IAAAA,MAAM,GAAGzD,cAAc,CAAC0D,cAAf,CAA8BnB,KAA9B,EAAqCE,MAArC,CAAT;AACAL,IAAAA,QAAQ,GAAGpC,cAAc,CAAC2D,oBAAf,CAAoCpB,KAApC,EAA2CE,MAA3C,CAAX;AACD,GAHD,MAGO;AACL,QAAImB,kBAAkB,GAAG,CAAzB;;AACAxB,IAAAA,QAAQ,GAAG,YAAY;AACrB,UAAIN,QAAQ,GAAG8B,kBAAf;AACAA,MAAAA,kBAAkB,IAAI,CAAtB;AACA,aAAO9B,QAAP;AACD,KAJD;;AAKA2B,IAAAA,MAAM,GAAG,CAAC;AAAElB,MAAAA,KAAK,EAAEA,KAAT;AAAgBE,MAAAA,MAAM,EAAEA;AAAxB,KAAD,CAAT;AACD;;AAED,OAAK,IAAIoB,UAAU,GAAG,CAAtB,EAAyBA,UAAU,GAAGJ,MAAM,CAAClD,MAA7C,EAAqDsD,UAAU,EAA/D,EAAmE;AACjE,QAAI/C,KAAK,KAAK,CAAd,EAAiB;AACfR,MAAAA,MAAM,GAAG4B,YAAY,CACnBuB,MAAM,CAACI,UAAD,CADa,EAEnB1D,MAFmB,EAGnBiC,QAHmB,EAInBC,GAJmB,EAKnBjC,IALmB,EAMnBE,MANmB,CAArB;AAQD,KATD,MASO;AACLwC,MAAAA,iBAAiB,CACfW,MAAM,CAACI,UAAD,CADS,EAEf1D,MAFe,EAGfiC,QAHe,EAIfC,GAJe,EAKfU,IALe,EAMfnC,MANe,CAAjB;AAQD;AACF;;AACD,MAAIE,KAAK,KAAK,CAAd,EAAiB;AACf,QAAIR,MAAM,KAAKF,IAAI,CAACG,MAApB,EAA4B;AAC1B,YAAM,IAAIC,KAAJ,CAAU,kBAAV,CAAN;AACD;AACF,GAJD,MAIO;AACLuC,IAAAA,IAAI,CAACd,GAAL;AACD;;AAED,SAAO9B,MAAP;AACD,CAjED","sourcesContent":["\"use strict\";\n\nlet interlaceUtils = require(\"./interlace\");\n\nlet pixelBppMapper = [\n  // 0 - dummy entry\n  function () {},\n\n  // 1 - L\n  // 0: 0, 1: 0, 2: 0, 3: 0xff\n  function (pxData, data, pxPos, rawPos) {\n    if (rawPos === data.length) {\n      throw new Error(\"Ran out of data\");\n    }\n\n    let pixel = data[rawPos];\n    pxData[pxPos] = pixel;\n    pxData[pxPos + 1] = pixel;\n    pxData[pxPos + 2] = pixel;\n    pxData[pxPos + 3] = 0xff;\n  },\n\n  // 2 - LA\n  // 0: 0, 1: 0, 2: 0, 3: 1\n  function (pxData, data, pxPos, rawPos) {\n    if (rawPos + 1 >= data.length) {\n      throw new Error(\"Ran out of data\");\n    }\n\n    let pixel = data[rawPos];\n    pxData[pxPos] = pixel;\n    pxData[pxPos + 1] = pixel;\n    pxData[pxPos + 2] = pixel;\n    pxData[pxPos + 3] = data[rawPos + 1];\n  },\n\n  // 3 - RGB\n  // 0: 0, 1: 1, 2: 2, 3: 0xff\n  function (pxData, data, pxPos, rawPos) {\n    if (rawPos + 2 >= data.length) {\n      throw new Error(\"Ran out of data\");\n    }\n\n    pxData[pxPos] = data[rawPos];\n    pxData[pxPos + 1] = data[rawPos + 1];\n    pxData[pxPos + 2] = data[rawPos + 2];\n    pxData[pxPos + 3] = 0xff;\n  },\n\n  // 4 - RGBA\n  // 0: 0, 1: 1, 2: 2, 3: 3\n  function (pxData, data, pxPos, rawPos) {\n    if (rawPos + 3 >= data.length) {\n      throw new Error(\"Ran out of data\");\n    }\n\n    pxData[pxPos] = data[rawPos];\n    pxData[pxPos + 1] = data[rawPos + 1];\n    pxData[pxPos + 2] = data[rawPos + 2];\n    pxData[pxPos + 3] = data[rawPos + 3];\n  },\n];\n\nlet pixelBppCustomMapper = [\n  // 0 - dummy entry\n  function () {},\n\n  // 1 - L\n  // 0: 0, 1: 0, 2: 0, 3: 0xff\n  function (pxData, pixelData, pxPos, maxBit) {\n    let pixel = pixelData[0];\n    pxData[pxPos] = pixel;\n    pxData[pxPos + 1] = pixel;\n    pxData[pxPos + 2] = pixel;\n    pxData[pxPos + 3] = maxBit;\n  },\n\n  // 2 - LA\n  // 0: 0, 1: 0, 2: 0, 3: 1\n  function (pxData, pixelData, pxPos) {\n    let pixel = pixelData[0];\n    pxData[pxPos] = pixel;\n    pxData[pxPos + 1] = pixel;\n    pxData[pxPos + 2] = pixel;\n    pxData[pxPos + 3] = pixelData[1];\n  },\n\n  // 3 - RGB\n  // 0: 0, 1: 1, 2: 2, 3: 0xff\n  function (pxData, pixelData, pxPos, maxBit) {\n    pxData[pxPos] = pixelData[0];\n    pxData[pxPos + 1] = pixelData[1];\n    pxData[pxPos + 2] = pixelData[2];\n    pxData[pxPos + 3] = maxBit;\n  },\n\n  // 4 - RGBA\n  // 0: 0, 1: 1, 2: 2, 3: 3\n  function (pxData, pixelData, pxPos) {\n    pxData[pxPos] = pixelData[0];\n    pxData[pxPos + 1] = pixelData[1];\n    pxData[pxPos + 2] = pixelData[2];\n    pxData[pxPos + 3] = pixelData[3];\n  },\n];\n\nfunction bitRetriever(data, depth) {\n  let leftOver = [];\n  let i = 0;\n\n  function split() {\n    if (i === data.length) {\n      throw new Error(\"Ran out of data\");\n    }\n    let byte = data[i];\n    i++;\n    let byte8, byte7, byte6, byte5, byte4, byte3, byte2, byte1;\n    switch (depth) {\n      default:\n        throw new Error(\"unrecognised depth\");\n      case 16:\n        byte2 = data[i];\n        i++;\n        leftOver.push((byte << 8) + byte2);\n        break;\n      case 4:\n        byte2 = byte & 0x0f;\n        byte1 = byte >> 4;\n        leftOver.push(byte1, byte2);\n        break;\n      case 2:\n        byte4 = byte & 3;\n        byte3 = (byte >> 2) & 3;\n        byte2 = (byte >> 4) & 3;\n        byte1 = (byte >> 6) & 3;\n        leftOver.push(byte1, byte2, byte3, byte4);\n        break;\n      case 1:\n        byte8 = byte & 1;\n        byte7 = (byte >> 1) & 1;\n        byte6 = (byte >> 2) & 1;\n        byte5 = (byte >> 3) & 1;\n        byte4 = (byte >> 4) & 1;\n        byte3 = (byte >> 5) & 1;\n        byte2 = (byte >> 6) & 1;\n        byte1 = (byte >> 7) & 1;\n        leftOver.push(byte1, byte2, byte3, byte4, byte5, byte6, byte7, byte8);\n        break;\n    }\n  }\n\n  return {\n    get: function (count) {\n      while (leftOver.length < count) {\n        split();\n      }\n      let returner = leftOver.slice(0, count);\n      leftOver = leftOver.slice(count);\n      return returner;\n    },\n    resetAfterLine: function () {\n      leftOver.length = 0;\n    },\n    end: function () {\n      if (i !== data.length) {\n        throw new Error(\"extra data found\");\n      }\n    },\n  };\n}\n\nfunction mapImage8Bit(image, pxData, getPxPos, bpp, data, rawPos) {\n  // eslint-disable-line max-params\n  let imageWidth = image.width;\n  let imageHeight = image.height;\n  let imagePass = image.index;\n  for (let y = 0; y < imageHeight; y++) {\n    for (let x = 0; x < imageWidth; x++) {\n      let pxPos = getPxPos(x, y, imagePass);\n      pixelBppMapper[bpp](pxData, data, pxPos, rawPos);\n      rawPos += bpp; //eslint-disable-line no-param-reassign\n    }\n  }\n  return rawPos;\n}\n\nfunction mapImageCustomBit(image, pxData, getPxPos, bpp, bits, maxBit) {\n  // eslint-disable-line max-params\n  let imageWidth = image.width;\n  let imageHeight = image.height;\n  let imagePass = image.index;\n  for (let y = 0; y < imageHeight; y++) {\n    for (let x = 0; x < imageWidth; x++) {\n      let pixelData = bits.get(bpp);\n      let pxPos = getPxPos(x, y, imagePass);\n      pixelBppCustomMapper[bpp](pxData, pixelData, pxPos, maxBit);\n    }\n    bits.resetAfterLine();\n  }\n}\n\nexports.dataToBitMap = function (data, bitmapInfo) {\n  let width = bitmapInfo.width;\n  let height = bitmapInfo.height;\n  let depth = bitmapInfo.depth;\n  let bpp = bitmapInfo.bpp;\n  let interlace = bitmapInfo.interlace;\n  let bits;\n\n  if (depth !== 8) {\n    bits = bitRetriever(data, depth);\n  }\n  let pxData;\n  if (depth <= 8) {\n    pxData = Buffer.alloc(width * height * 4);\n  } else {\n    pxData = new Uint16Array(width * height * 4);\n  }\n  let maxBit = Math.pow(2, depth) - 1;\n  let rawPos = 0;\n  let images;\n  let getPxPos;\n\n  if (interlace) {\n    images = interlaceUtils.getImagePasses(width, height);\n    getPxPos = interlaceUtils.getInterlaceIterator(width, height);\n  } else {\n    let nonInterlacedPxPos = 0;\n    getPxPos = function () {\n      let returner = nonInterlacedPxPos;\n      nonInterlacedPxPos += 4;\n      return returner;\n    };\n    images = [{ width: width, height: height }];\n  }\n\n  for (let imageIndex = 0; imageIndex < images.length; imageIndex++) {\n    if (depth === 8) {\n      rawPos = mapImage8Bit(\n        images[imageIndex],\n        pxData,\n        getPxPos,\n        bpp,\n        data,\n        rawPos\n      );\n    } else {\n      mapImageCustomBit(\n        images[imageIndex],\n        pxData,\n        getPxPos,\n        bpp,\n        bits,\n        maxBit\n      );\n    }\n  }\n  if (depth === 8) {\n    if (rawPos !== data.length) {\n      throw new Error(\"extra data found\");\n    }\n  } else {\n    bits.end();\n  }\n\n  return pxData;\n};\n"]},"metadata":{},"sourceType":"script"}